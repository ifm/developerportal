<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ifm3d - Implementing a Custom Image Container &mdash; O3R  documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> O3R
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../documentation/O3R/README.html">O3R</a></li>
<li class="toctree-l1"><a class="reference internal" href="sphinx/index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="sphinx/content/installation_instructions.html">Installation instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="sphinx/cli_link.html">Command Line tool</a></li>
<li class="toctree-l1"><a class="reference internal" href="sphinx/python_api.html">Python API</a></li>
<li class="toctree-l1"><a class="reference internal" href="sphinx/cpp_api/annotated.html">C++ API</a></li>
<li class="toctree-l1"><a class="reference internal" href="sphinx/index.html">Indices and tables</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">O3R</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>ifm3d - Implementing a Custom Image Container</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/ifm3d/doc/img_container.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="ifm3d-implementing-a-custom-image-container">
<h1>ifm3d - Implementing a Custom Image Container<a class="headerlink" href="#ifm3d-implementing-a-custom-image-container" title="Permalink to this headline"></a></h1>
<p><code class="docutils literal notranslate"><span class="pre">ifm3d</span></code> provides a full software stack for writing computer vision / robotics
perception applications based upon ifm 3D cameras and the pmd ToF chip. <code class="docutils literal notranslate"><span class="pre">ifm3d</span></code>
ships, as part of its core, two <em>image modules</em>. They are <code class="docutils literal notranslate"><span class="pre">image</span></code> and
<code class="docutils literal notranslate"><span class="pre">opencv</span></code>. The <code class="docutils literal notranslate"><span class="pre">image</span></code> module bridges the 3D camera data to both OpenCV and
PCL, while <code class="docutils literal notranslate"><span class="pre">opencv</span></code> exclusively bridges to OpenCV dropping any required PCL
dependencies for users. <code class="docutils literal notranslate"><span class="pre">ifm3d</span></code>, through its modularity, also encourages the
creation of new image containers to be utilized within the overall <code class="docutils literal notranslate"><span class="pre">ifm3d</span></code>
ecosystem. For example, you may want to create bindings to
<a class="reference external" href="http://eigen.tuxfamily.org">Eigen</a>,
<a class="reference external" href="https://github.com/QuantStack/xtensor">xtensor</a>, or maybe even a proprietary
format to be used internally at your company. The purpose of this document is
to help would-be image-container authors to be able to start quickly.</p>
<p>The example code in this document is intentionally basic so as to not cloud the
mechanics of writing an image container with the practicalities of writing
robust real-world software. For real-world examples, please consult the source
code for the <code class="docutils literal notranslate"><span class="pre">image</span></code> and/or <code class="docutils literal notranslate"><span class="pre">opencv</span></code> image containers shipped as part of this
source distribution. We note, the <code class="docutils literal notranslate"><span class="pre">image</span></code> module provides an example which
builds a library that can be linked to at runtime, while the <code class="docutils literal notranslate"><span class="pre">opencv</span></code> module is
implemented as a header-only library.</p>
<p>The first step in writing an image container for <code class="docutils literal notranslate"><span class="pre">ifm3d</span></code> is to sub-class the
<code class="docutils literal notranslate"><span class="pre">ifm3d::ByteBuffer</span></code> class (part of the <code class="docutils literal notranslate"><span class="pre">framegrabber</span></code>
module). <code class="docutils literal notranslate"><span class="pre">ifm3d::ByteBuffer</span></code> is a template class designed to facilitate
<em>static</em> (compile-time) polymorphic class hierarchies. That is, there are no
<code class="docutils literal notranslate"><span class="pre">virtual</span></code> functions (i.e., no runtime polymorphism) and by association, no
vtable lookups at runtime. To those who are familiar with this idea,
<code class="docutils literal notranslate"><span class="pre">ifm3d::ByteBuffer</span></code> imposes the usage of
<a class="reference external" href="https://en.wikipedia.org/wiki/Curiously_recurring_template_pattern">CRTP</a>.</p>
<p>The most simple image container implementation looks something like this:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyBuff</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">ifm3d</span><span class="o">::</span><span class="n">ByteBuffer</span><span class="o">&lt;</span><span class="n">MyBuff</span><span class="o">&gt;</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="w">  </span><span class="n">MyBuff</span><span class="p">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">ifm3d</span><span class="o">::</span><span class="n">ByteBuffer</span><span class="o">&lt;</span><span class="n">MyBuff</span><span class="o">&gt;</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;ctor&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">ImCreate</span><span class="p">(</span><span class="n">ifm3d</span><span class="o">::</span><span class="n">image_chunk</span><span class="w"> </span><span class="n">im</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">std</span><span class="o">::</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">fmt</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="w"> </span><span class="n">idx</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">std</span><span class="o">::</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">std</span><span class="o">::</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">height</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">nchan</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">std</span><span class="o">::</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">npts</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kt">uint8_t</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">bytes</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;ImCreate: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="n">im</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">CloudCreate</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">fmt</span><span class="p">,</span><span class="w"></span>
<span class="w">                   </span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="w"> </span><span class="n">xidx</span><span class="p">,</span><span class="w"></span>
<span class="w">                   </span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="w"> </span><span class="n">yidx</span><span class="p">,</span><span class="w"></span>
<span class="w">                   </span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="w"> </span><span class="n">zidx</span><span class="p">,</span><span class="w"></span>
<span class="w">                   </span><span class="n">std</span><span class="o">::</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"></span>
<span class="w">                   </span><span class="n">std</span><span class="o">::</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">height</span><span class="p">,</span><span class="w"></span>
<span class="w">                   </span><span class="n">std</span><span class="o">::</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">npts</span><span class="p">,</span><span class="w"></span>
<span class="w">                   </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kt">uint8_t</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">bytes</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;CloudCreate&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
<p>There are two <em>callback</em> (template) functions that must be implemented by every
image container. They are <code class="docutils literal notranslate"><span class="pre">ImCreate</span></code> and <code class="docutils literal notranslate"><span class="pre">CloudCreate</span></code>. The arguments are
well described in the <code class="docutils literal notranslate"><span class="pre">modules/framegrabber/include/ifm3d/fg/byte_buffer.h</span></code>
file and for the sake of brevity are not repeated here. However, we do want to
point out some key pieces of information critical for image container
authors. This information now follows.</p>
<p>For each frame received from the camera all 2D images will be processed first
by calls to <code class="docutils literal notranslate"><span class="pre">ImCreate</span></code> (called n-times per frame, once for each image type,
depending upon your active PCIC schema passed to the framegrabber). Then, a
single call to <code class="docutils literal notranslate"><span class="pre">CloudCreate</span></code> is made with the 3D cartesian data <em>if</em> the
cartesian data are specified in your pcic schema. If they are not,
<code class="docutils literal notranslate"><span class="pre">CloudCreate</span></code> will not be called. It is also important to note that the first
call to <code class="docutils literal notranslate"><span class="pre">ImCreate</span></code> for each frame will be the confidence data. This is so
that for each subsequent image type (or point cloud), the confidence image (for
the current frame) can be referenced to see, for example, if a given pixel is
valid or not – i.e., you may want to populate bad pixels as NaN in your
container implementation.</p>
<p>We also note that both <code class="docutils literal notranslate"><span class="pre">ImCreate</span></code> and <code class="docutils literal notranslate"><span class="pre">CloudCreate</span></code> are template functions
that take a single template parameter <code class="docutils literal notranslate"><span class="pre">T</span></code>. <code class="docutils literal notranslate"><span class="pre">T</span></code> represents the C++ pixel
data type. So, if you are using a strongly-typed container that supports
template parameters, you can pass <code class="docutils literal notranslate"><span class="pre">T</span></code> straight through and not incur the
overhead of performing a lookup on the <code class="docutils literal notranslate"><span class="pre">fmt</span></code> argument (which is redundant
with <code class="docutils literal notranslate"><span class="pre">T</span></code>).</p>
<p>Using your custom image container will look very similar to using the standard
image containers shipped with <code class="docutils literal notranslate"><span class="pre">ifm3d</span></code>. Synthesizing a hypothetical example
that would utilize our (very simple and useless) container from above, you
could write client code like:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">auto</span><span class="w"> </span><span class="n">cam</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ifm3d</span><span class="o">::</span><span class="n">Camera</span><span class="o">::</span><span class="n">MakeShared</span><span class="p">();</span><span class="w"></span>
<span class="k">auto</span><span class="w"> </span><span class="n">fg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">ifm3d</span><span class="o">::</span><span class="n">FrameGrabber</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cam</span><span class="p">);</span><span class="w"></span>
<span class="k">auto</span><span class="w"> </span><span class="n">buff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">MyBuff</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span>

<span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">fg</span><span class="o">-&gt;</span><span class="n">WaitForFrame</span><span class="p">(</span><span class="n">buff</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span><span class="w"> </span><span class="mi">1000</span><span class="p">))</span><span class="w"></span>
<span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// ... now use buff ..</span>
<span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>For clarity, we also note that the methods/accessors defined in the base
<code class="docutils literal notranslate"><span class="pre">ifm3d::ByteBuffer</span></code> class are available to your custom containers as well. So,
access to the extrinsics, timestamp, illumination temperature, and raw bytes
are available with no extra work required by you.</p>
<p>Again, we strongly urge you to inspect the code for the <code class="docutils literal notranslate"><span class="pre">image</span></code> and <code class="docutils literal notranslate"><span class="pre">opencv</span></code>
modules that we ship with <code class="docutils literal notranslate"><span class="pre">ifm3d</span></code>. This will give you a very concrete example
as to how you can implement your own image container types in a more realistic
way (i.e., how to parse the pixels, byte swap them, deal with copy/move
semantics, etc.). If you have questions, feel free to ask on our
<a class="reference external" href="https://github.com/ifm/ifm3d/issues">issue tracker</a>.</p>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, ifm CSR.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>